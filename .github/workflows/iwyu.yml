name: Include What You Use

on:
  push:
    branches: ["main"]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Debug

jobs:
  include-what-you-use:
    # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
    # You can convert this to a matrix build if you need cross-platform coverage.
    # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Install Dependencies
      run: sudo apt update && sudo apt install -y cmake clang iwyu

    - name: Configure CMake (Include What You Use)
      run: |
        CC="clang" CXX="clang++" \
        cmake -B ${{github.workspace}}/build \
        -DCMAKE_CXX_INCLUDE_WHAT_YOU_USE="include-what-you-use"

    - name: Build with IWYU
      run: cmake --build ${{github.workspace}}/build --verbose 2>&1 | tee iwyu_output.txt || true

    - name: Check IWYU results
      run: |
        if grep -q "should add these lines\|should remove these lines" iwyu_output.txt; then
          echo "::error::Include-what-you-use found issues"
          exit 1
        fi
